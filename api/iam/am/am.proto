// Copyright 2018 The OpenPitrix Authors. All rights reserved.
// Use of this source code is governed by a Apache license
// that can be found in the LICENSE file.

syntax = "proto3";

package iam.am;

option go_package = "openpitrix.io/iam/pkg/pb/am;pbam";

// ----------------------------------------------------------------------------
// basic type
// ----------------------------------------------------------------------------

// GET /api/v1/repos/repo-abcd/create_time
//	verbs: GET
//	api_version: v1
//	api_group: null
//	resource: repos
//	resource_name: repo-abcd
//	sub_resource: create_time
//	non_resource: null

// get user runtimes
//	GET /api/v1/users/user-name/runtimes
//	GET /api/v1/runtimes/rt-abcd/cpu-num

message Rule {
	repeated string verbs = 1; // '*' is all

	string api_version = 2;    // '*' is all
	string api_group = 3;      // '*' is all
	string resource = 4;       // '*' is all

	repeated string resource_name = 5;
	repeated string sub_resource_regexp = 6;
	repeated string non_resource = 7;

	map<string,string> extra = 8;
}

message Role {
	string name = 1; // primary key
	repeated Rule rule = 2;
}

message RoleList {
	repeated Role value = 1;
}

message Action {
	string uid = 1;
	string role_name = 2;

	string verbs = 3;
	string path = 4;
}

// ----------------------------------------------------------------------------
// service api
// ----------------------------------------------------------------------------

service AccessManager {
	rpc CreateRole(Role) returns (Role);
	rpc ModifyRole(Role) returns (Role);
	rpc DeleteRoleByName(String) returns (Bool);

	rpc GetRoleByRoleName(String) returns (Role);
	rpc GetRoleByUserId(UserId) returns (RoleList);
	rpc ListRoles(Range) returns (ListRolesResponse);

	rpc CreateRoleBinding(RoleBindingList) returns (Bool);
	rpc DeleteRoleBinding(RoleBindingList) returns (Bool);
	rpc DeleteAllRoleBindings(UserId) returns (Bool);

	rpc IsGranted(Action) returns (Bool);
}

// ----------------------------------------------------------------------------
// service api type
// ----------------------------------------------------------------------------

message Bool {
	bool value = 1;
}
message String {
	string value = 1;
}

message UserId {
	string value = 1;
}

message Range {
	string role_name_regexp = 1;
	int32 offset = 2;
	int32 limit = 3;
}

message ListRolesResponse {
	repeated Role role = 1;
	int32 total = 2;
}

message RoleBinding {
	string uid = 1;
	string role_name = 2;
}
message RoleBindingList {
	string uid = 1;
	string role_name = 2;
}

// ----------------------------------------------------------------------------
// END
// ----------------------------------------------------------------------------
